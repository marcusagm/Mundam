# Plan: Robustness, File Formats & UI Polish

> **Generated by:** Antigravity (Project Planner)
> **Date:** 2026-02-02
> **Context:** Finalizing "Code Review" Tasks and implementing "Unified Media Detection System".

---

## 1. Overview
This plan addresses the remaining technical debt identified in `docs/report/code-review.md` and implements the robust file format handling detailed in `docs/report/file-formats.md`.

The goals are:
1.  **Backend Robustness:** Eliminate panics (`unwrap`), fix blocking I/O, and unify file format definitions.
2.  **Frontend Polish:** Clean up VirtualMasonry logic, standardize state management, and prevent layout thrashing.
3.  **Single Source of Truth:** Make the Backend the authority on supported file formats.

## 2. Project Type
**Desktop (Tauri)**
-   **Frontend:** WEB (SolidJS, TypeScript)
-   **Backend:** BACKEND (Rust, SQLite)

## 3. Success Criteria
-   [ ] **File Formats:** `src-tauri/src/formats.rs` exists and defines all supported types.
-   [ ] **Detection:** Files are detected by Magic Bytes first (`infer` crate), extension second.
-   [ ] **No Panics:** `unwrap()` removed from critical paths in `thumbnails.rs`.
-   [ ] **Non-Blocking:** Heavy I/O/CPU operations in `thumbnails.rs` run in `spawn_blocking`.
-   [ ] **Frontend Sync:** Frontend loads supported formats from Backend command `get_supported_formats`.
-   [ ] **Masonry Polish:** Hardcoded values (gap, buffer) moved to config/props.

## 4. Tech Stack
-   **Rust:** `infer` (Magic Bytes), `mime_guess`, `strum`.
-   **Frontend:** SolidJS Stores, Tauri Invoke.

## 5. Task Breakdown

### Phase 1: Unified Media Detection System (Backend)
| ID | Task | Input | Output | Verify |
|----|------|-------|--------|--------|
| B-1 | Add Dependencies | `Cargo.toml` | `infer`, `mime_guess`, `strum`, `serde` added | `cargo check` passes |
| B-2 | Create Format Registry | `docs/report/file-formats.md` | `src-tauri/src/formats.rs` | Enum `MediaType` & `FileFormat` struct exist |
| B-3 | Implement Connectors | `formats.rs` | `FileFormat::detect(path)` method | Test with renamed `.jpg` -> `.txt` (should detect as jpeg) |
| B-4 | Refactor Thumbnails | `src-tauri/src/thumbnails.rs` | Use `formats::detect` instead of match | `get_strategy` is clean and short |
| B-5 | Expose to Frontend | `src-tauri/src/lib.rs` | `#[tauri::command] get_supported_formats` | Frontend receives JSON list of formats |

### Phase 2: Backend Robustness
| ID | Task | Input | Output | Verify |
|----|------|-------|--------|--------|
| B-6 | Fix Blocking I/O | `thumbnails.rs` | Wrap `image::open` in `spawn_blocking` | UI doesn't freeze during thumbnail gen |
| B-7 | Remove Unwraps | `thumbnails.rs` | Replace `unwrap()` with `?` or `match` | `grep "unwrap"` returns 0 in `thumbnails.rs` |

### Phase 3: Frontend Polish
| ID | Task | Input | Output | Verify |
|----|------|-------|--------|--------|
| F-1 | Consume Formats | `src/core/store/system.ts` | `loadFormats()` action | `console.log` shows loaded formats |
| F-2 | Masonry Config | `VirtualMasonry.tsx` | Prop-based `gap` and `buffer` | Change gap prop -> layout updates |
| F-3 | Clean Conditional | `VirtualMasonry.tsx` | Remove redundant `if (!pos)` checks | Scroll is smooth, no flickering |
| F-4 | Fix MultiInspector | `MultiInspector.tsx` | Add empty selection guard | No crash when clearing selection |
| F-5 | Standardize State | `ImageDropStrategy.ts` | Use Hooks instead of direct store import | Code consistency |

## 6. Phase X: Verification Checklist
-   [ ] **File Detection:** Renovating a PNG to .txt and importing should still work (Magic Bytes).
-   [ ] **Stability:** Scanning a folder with corrupted images should not crash backend (Error handling).
-   [ ] **UI Performance:** Scrolling grid while generating thumbnails keeps 60fps (Non-blocking I/O).
-   [ ] **Configuration:** Changing supported formats in Rust automatically updates Frontend filters.

## 7. Next Steps
-   Execute tasks in order: B-1 -> B-5 -> B-6/7 -> F-1...F-5.
