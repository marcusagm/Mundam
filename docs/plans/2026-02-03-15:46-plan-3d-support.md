# 3D Support Implementation Plan (Assimp Pipeline)

This plan outlines the implementation of 3D file support using the "Universal Pipeline" strategy (Assimp -> GLTF).

## üéØ Objective
Enable the application to:
1.  **Ingest** 40+ 3D file formats (FBX, OBJ, DAE, BLEND, etc.).
2.  **Convert** them to a standard web-ready format (GLB) for caching.
3.  **Render** interactive previews in the `ModelViewer`.
4.  **Generate** static thumbnails for the library grid.

## üèó Architecture

### 1. The Core Converter (Rust)
We will use `russimp` (Rust bindings for the Open Asset Import Library) as the core engine.
- **Input:** Any Assimp-supported format.
- **Processing:**
    - Import scene.
    - Optimizations (Mesh joining, etc. if needed).
    - Export to `.glb` (binary GLTF) stored in a persistent cache folder.
- **Output:** Path to cached `.glb`.

### 2. The Thumbnailer
Generating a 2D image from a 3D file without a window context is complex.
- **Strategy:**
    - Primary: Convert to GLB first.
    - Secondary: Attempt to extract embedded thumbnails (common in Blender/SketchUp).
    - Tertiary (Rendering): Use a headless rendering approach (e.g., `headless_chrome` pointing to a local specialized HTML render page, or a CLI tool like `f3d` if bundled).
    - **MVP Choice:** For the first iteration, we will focus on **Conversion (GLB)**. If a thumbnail cannot be easily extracted, we will use a "Generated 3D Icon" or a placeholder, but ensure the *Preview* works.

### 3. The Frontend Viewer
- Update `ModelViewer.tsx` to use `<model-viewer>` (Google's component) or `react-three-fiber` (via Solid equivalent or basic Three.js).
- Point it to the local asset URL of the cached GLB.

---

## üìÖ Implementation Steps

### Phase 1: Dependencies & Setup
- [x] **System Requirements:** Verified `Assimp` can be used (decided on CLI Bundle strategy for stability).
- [x] **Rust Dependencies:** Switched to `std::process::Command` for bundled binary execution instead of `russimp` to avoid linkage hell.

### Phase 2: The Conversion Logic
- [x] **Create Module:** `src-tauri/src/thumbnails/model.rs`.
- [x] **Implement Conversion:** Created `generate_model_preview` using Assimp CLI export to GLB.
- [x] **Update Registry:**
    - Modified `src-tauri/src/formats.rs` to register formats (FBX, DAE, OBJ, BLEND, 3DS, DXF, LWO, STL).

### Phase 3: Integration with Thumbnail Worker
- [x] **Update `generate_thumbnail` in `mod.rs`**:
    - Added `ThumbnailStrategy::Model3D`.
    - Logic implemented: Auto-converts to GLB in cache and creates a fallback WebP icon for the grid.

### Phase 4: Frontend Visualization
- [x] **Update `ModelViewer.tsx`**:
    - Integrated `<model-viewer>`.
    - Added Loader.
    - Added support for `.dae` and other extensions in `ItemView.tsx`.

### Phase 5: Testing & Optimization
- [x] **Test Formats:** Verified FBX, OBJ, GLTF, GLB, DAE, BLEND (partial), STL, 3DS, DXF.
- [x] **Performance:** Conversion happens in background worker.
- [x] **Caching:** Checks for existing GLB before converting.

---

## üöÄ Phase 6: UI Refinement & Polish (Added)
- [x] **Dedicated Toolbar:**
    - Created `ModelToolbar.tsx` with Auto-Rotate, Grid Toggle, and Background Color controls.
    - Enabled correct state management in `ItemViewContext`.
- [x] **Styling:**
    - Created `model-viewer.css` using design tokens.
    - Implemented Grid visualization via CSS gradients.
- [x] **Interactive Controls:**
    - Fixed Auto-Rotate logic using imperative `createEffect`.
    - Fixed Reset View logic to properly reset 3D camera without unmounting component.

## ‚ö†Ô∏è Risks & Outcomes
- **Outcome:** The strategy to use `Assimp CLI` wrapped in Rust proved successful and much more stable than linking C++ libraries directly.
- **Outcome:** Proprietary formats (MAX, C4D) remain unsupported as expected, but open standards work perfectly.
