# Plan: Optimization & Refactoring (Frontend/Backend)

> **Generated by:** Antigravity (Project Planner)
> **Date:** 2026-02-02
> **Context:** Post-Audit Refactoring based on `docs/report/code-review.md`.

---

## 1. Overview
This plan addresses critical scalability and architecture issues identified in the "Code Review: Part 1 & 2". The goal is to ensure the application can handle libraries of 20,000+ images with smooth 60fps scrolling and sub-millisecond search/sort times.

Work covers both:
1.  **Frontend:** Virtualization performance (VirtualMasonry), Component Decoupling.
2.  **Backend:** Database optimization (FTS5, Indices) and Query robustness.

## 2. Project Type
**Desktop (Tauri)**
-   **Frontend:** WEB (SolidJS, TypeScript)
-   **Backend:** BACKEND (Rust, SQLite)

## 3. Success Criteria
-   [x] **Frontend:** `VirtualMasonry` renders only visible items (O(1) complexity via Spatial Grid).
-   [x] **Frontend:** Layout calculations moved to Web Worker (Main Thread unblocked).
-   [x] **Frontend:** `AssetCard` fully decoupled from global state (Pure Component).
-   [x] **Backend:** Text Search uses SQLite FTS5 (Full-Text Search) instead of `LIKE %...%`.
-   [x] **Backend:** Sorting columns (`rating`, `size`, `created_at`) have Database Indices.
-   [x] **Backend:** Recursive folder queries have depth limits to prevent infinite loops.

## 4. Tech Stack
-   **Core:** Tauri v2 (Rust + WebView)
-   **Frontend:** SolidJS, TypeScript, Web Workers
-   **Database:** SQLite (via sqlx) with FTS5 extension
-   **Search:** Trigram Tokenizer for substring matching

## 5. File Structure (Key Changes)
```
/
├── src/
│   ├── components/features/viewport/
│   │   ├── VirtualMasonry.tsx       # (Refactored) Uses Worker + Spatial Grid
│   │   └── AssetCard.tsx            # (Refactored) Pure Component
│   └── core/viewport/
│       └── layout.worker.ts         # (New) Off-thread layout engine
├── src-tauri/
│   ├── src/
│   │   ├── schema.sql               # (Updated) Added FTS5 table + Triggers + Indices
│   │   └── search_logic.rs          # (Updated) FTS5 MATCH queries + Date parsing
│   └── Cargo.toml                   # (Config) Added dependencies
```

## 6. Task Breakdown

### Phase 1: Frontend Scalability (✅ Completed)
| ID | Task | Input | Output | Verify |
|----|------|-------|--------|--------|
| F-1 | Implement Spatial Grid in Worker | `VirtualMasonry.tsx` O(N) | `layout.worker.ts` O(1) | Scroll 20k items @ 60fps |
| F-2 | Offload Layout Calculation | Main Thread Math | Web Worker Message | Resize window keeps UI responsive |
| F-3 | Decouple AssetCard | Global Hooks usage | Props-only Interface | Component renders in Storybook/isolated |
| F-4 | Optimize Drag-and-Drop | `allItems` dependency | ID-only ref | Drag start instant for large lists |

### Phase 2: Backend Performance (✅ Completed)
| ID | Task | Input | Output | Verify |
|----|------|-------|--------|--------|
| B-1 | Create FTS5 Table | `schema.sql` | Virtual Table + Triggers | `SELECT * FROM images_fts` returns data |
| B-2 | Implement FTS5 Query | `search_logic.rs` | `MATCH` operator usage | Search "test" takes <1ms |
| B-3 | Add Sort Indices | `schema.sql` | `CREATE INDEX ...` | Sort by Rating is instant |
| B-4 | Robust Date Parsing | `DD/MM/YYYY` strings | ISO-8601 internal logic | Search allows different date formats |
| B-5 | Limit Recursion | Infinite loop risk | `WHERE depth < 50` | Circular links don't crash app |

### Phase 3: Integrity & Polish (✅ Completed)
| ID | Task | Input | Output | Verify |
|----|------|-------|--------|--------|
| I-1 | File Watcher Integration | `notify` crate | Auto-sync DB on external move | Rename file in Explorer -> DB updates |
| U-1 | Verify Masonry-H | Horizontal Layout | Flickr-style Justified Layout | Last row doesn't stretch weirdly |

---

## 7. Phase X: Verification Checklist

### Performance
-   [x] **Scroll Test:** No jank when scrolling fast through populated library.
-   [x] **Search Test:** "Contains" query returns results immediately.
-   [x] **Resize Test:** Window resize recalculates layout without freezing.

### Code Quality
-   [x] **AssetCard:** No direct imports of `useStore` or singletons.
-   [x] **Safety:** `unwrap()` calls reduced/guarded in search logic.
-   [x] **SQL:** No redundant `LIKE` wildcards where FTS can be used.

### Next Steps
-   Start **Code Review Part 3** to audit new frontend code or other pending modules.
