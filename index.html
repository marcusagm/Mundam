<!doctype html>
<html lang="en">
    <head>
        <meta charset="utf-8" />
        <meta name="viewport" content="width=device-width, initial-scale=1" />
        <style>
            @font-face {
                font-family: 'Poppins';
                src: url('/Poppins/Poppins-Regular.ttf') format('truetype');
                font-weight: 400;
                font-style: normal;
            }
            @font-face {
                font-family: 'Poppins';
                src: url('/Poppins/Poppins-Medium.ttf') format('truetype');
                font-weight: 500;
                font-style: normal;
            }
        </style>
        <style>
            /* 
         Loader Styling - Scoped to #splash-screen to prevent conflicts.
         Colors match tokens.css manually to ensure 1:1 match without import issues.
      */
            #splash-screen {
                position: fixed;
                inset: 0;
                z-index: 9999;
                background-color: oklch(13% 0 0); /* bg-color */
                display: flex;
                flex-direction: column;
                align-items: center;
                justify-content: center;
                font-family:
                    'Poppins',
                    -apple-system,
                    BlinkMacSystemFont,
                    'Segoe UI',
                    Roboto,
                    sans-serif;
                color: #969696; /* text-secondary */
                transition: opacity 0.3s ease-out;
            }

            #splash-loader {
                position: relative;
                width: 60px;
                height: 60px;
                margin-bottom: 24px;
                display: flex;
                align-items: center;
                justify-content: center;
            }

            .splash-card {
                position: absolute;
                width: 30px;
                height: 35px;
                border: 3px solid oklch(13% 0 0);
                background-color: #00a0a9;
                border-radius: 4px;
                transform-origin: bottom center;
                box-sizing: border-box;
            }

            .card-1 { z-index: 3; animation: card-1-anim 3s ease-in-out infinite; }
            .card-2 { z-index: 2; animation: card-2-anim 3s ease-in-out infinite; }
            .card-3 { z-index: 1; animation: card-3-anim 3s ease-in-out infinite; }

            @keyframes card-1-anim {
                0%, 25% { transform: rotate(0deg); }
                45% { transform: rotate(0deg); }
                65% { transform: rotate(180deg); }
                85%, 100% { transform: rotate(360deg); }
            }

            @keyframes card-2-anim {
                0%, 25% { transform: rotate(-30deg); }
                45% { transform: rotate(0deg); }
                65% { transform: rotate(180deg); }
                85%, 100% { transform: rotate(330deg); }
            }

            @keyframes card-3-anim {
                0%, 25% { transform: rotate(-60deg); }
                45% { transform: rotate(0deg); }
                65% { transform: rotate(180deg); }
                85%, 100% { transform: rotate(300deg); }
            }

            #splash-text {
                font-size: 14px;
                font-weight: 400;
                letter-spacing: 0.5px;
            }

            #splash-error {
                display: none;
                flex-direction: column;
                align-items: center;
                gap: 16px;
                text-align: center;
            }

            #splash-error-msg {
                color: #f48771; /* danger-color */
                max-width: 80%;
            }

            #splash-reload {
                padding: 8px 16px;
                background-color: #00a0a9;
                color: #ffffff;
                border: none;
                border-radius: 4px;
                cursor: pointer;
                font-weight: 600;
                text-transform: uppercase;
                font-size: 12px;
            }
        </style>
    </head>

    <body>
        <noscript>You need to enable JavaScript to run this app.</noscript>

        <!-- Sibling Loader - NOT inside root -->
        <div id="splash-screen">
            <div
                id="splash-content"
                style="display: flex; flex-direction: column; align-items: center"
            >
                <div id="splash-loader">
                    <div class="splash-card card-3"></div>
                    <div class="splash-card card-2"></div>
                    <div class="splash-card card-1"></div>
                </div>
                <div id="splash-text">Initializing Mundam...</div>
            </div>

            <div id="splash-error">
                <div id="splash-error-msg">Application failed to start.</div>
                <button id="splash-reload" onclick="window.location.reload()">Reload</button>
            </div>
        </div>

        <!-- Application Root -->
        <div id="root"></div>

        <script>
            (function () {
                const splash = document.getElementById('splash-screen');
                const content = document.getElementById('splash-content');
                const errorView = document.getElementById('splash-error');
                const errorMsg = document.getElementById('splash-error-msg');
                const text = document.getElementById('splash-text');

                // 1. Listen for App Ready Event
                window.addEventListener('app-ready', () => {
                    splash.style.opacity = '0';
                    setTimeout(() => splash.remove(), 300); // Remove after fade
                });

                // 2. Global Error Handler (Boot Phase)
                window.onerror = function (msg, source, lineno, colno, error) {
                    if (document.body.contains(splash)) {
                        content.style.display = 'none';
                        errorView.style.display = 'flex';
                        errorMsg.textContent = msg || 'Unknown startup error';
                        return false;
                    }
                };

                // 3. Long Load Warning (5s)
                const timeout = setTimeout(() => {
                    if (document.body.contains(splash) && content.style.display !== 'none') {
                        text.textContent = 'Taking longer than usual...';
                    }
                }, 5000);

                // Cleanup timeout on success
                window.addEventListener('app-ready', () => clearTimeout(timeout));
            })();
        </script>

        <script src="/src/index.tsx" type="module"></script>
    </body>
</html>
